//变量移到全局调整
  window.chgBackgroundlist={
      '*样板示例':{
          //不播放攻击动画（默认点击即进入）
          '无点击动画':true,
          //'背景调整':1,直接调整缩放
          '背景调整':{//调整缩放比例和位置
              'X轴':0.5,//默认为0.5
              'Y轴':0.3,//默认为0.3
              '缩放':1,//默认为1
          },
          '形象调整':{
              'X轴':0.35,
              'Y轴':0.7,
              '缩放':0.55*1.5,
          },
          '骨骼设定':{
              '类型':{
                  '背景':'BeiJing.skel',//默认为BeiJing.skel
                  '形象':'XingXiang.skel',//默认为XingXiang.skel
              },
              '动画':{
                  '背景-1':'chuchang',//默认为chuchang
                  '背景-2':'beijing',//默认为beijing
                  '形象-1':'chuchang',//默认为chuchang
                  '形象-2':'daiji',//默认为daiji
                  '形象-3':'gongji',//默认为gongji
              },
          },
      },
      '戏志才·举棋若定':{
          '背景调整':1,
          '形象调整':{
              'X轴':0.35,
              'Y轴':0.6,
              '缩放':0.55*1.2,
          },
      },
      '祝融·野火燎原':{
          '背景调整':1,
          '形象调整':{
              'X轴':0.27,
              'Y轴':0.7,
              '缩放':0.55*1.2,
          },
      },
      '法正·恩山怨海':{
          '背景调整':1,
          '形象调整':{
              'X轴':0.35,
              'Y轴':0.7,
              '缩放':0.55*1.2,
          },
      },
      '蔡文姬·以身证道':{
          '背景调整':1,
          '形象调整':{
              'X轴':0.43,
              'Y轴':0.7,
              '缩放':0.55*1.2,
          },
      },
      '杨婉·明良千古':{
          '背景调整':1.25,
          '形象调整':{
              'X轴':0.2,
              'Y轴':0.63,
              '缩放':0.55*1.2,
          },
      },
      '貂蝉·舞惑群心':{
          '背景调整':1,
          '形象调整':{
              'X轴':0.2,
              'Y轴':0.65,
              '缩放':0.55*1.2,
          },
      },
      '钟会·潜蛟觊天':{
          '背景调整':{
              'X轴':0.27,//默认为0.5
              'Y轴':0.7,//默认为0.3
              '缩放':0.91*1.1,//默认为1
          },
          '形象调整':{
              'X轴':0.27,
              'Y轴':0.7,
              '缩放':0.55*1.3*1.1,
          },
      },
      '刘赪·明良千古':{
          '背景调整':{
              'X轴':0.5,//默认为0.5
              'Y轴':0.6,//默认为0.3
              '缩放':1,//默认为1
          },
          '形象调整':{
              'X轴':0.4,
              'Y轴':0.75,
              '缩放':0.55*1.2,
          },
      },
      '卑弥呼·呼风唤雨':{
          '背景调整':{
              'X轴':0.5,//默认为0.5
              'Y轴':0.4,//默认为0.3
              '缩放':1,//默认为1
          },
          '形象调整':{
              'X轴':0.5,
              'Y轴':0.7,
              '缩放':0.55*1.3,
          },
      },
      '吕布·傲睨万物':{
          '背景调整':{
              'X轴':0.5,//默认为0.5
              'Y轴':0.6,//默认为0.3
              '缩放':0.8,//默认为1
          },
          '形象调整':{
              'X轴':0.35,
              'Y轴':0.6,
              '缩放':0.55*1.2,
          },
      },
      '夏侯氏·明良千古':{
          '背景调整':{
              'X轴':0.36,//默认为0.5
              'Y轴':0.63,//默认为0.3
              '缩放':0.85,//默认为1
          },
          '形象调整':{
              'X轴':0.35,
              'Y轴':0.62,
              '缩放':0.55*1.2,
          },
      },
      '大乔·衣垂绿川':{
          '背景调整':1,
          '形象调整':{
              'X轴':0.4,
              'Y轴':0.65,
              '缩放':0.55*1.2,
          },
      },
      '小乔·采莲江南':{
          '背景调整':1,
          '形象调整':{
              'X轴':0.5,
              'Y轴':0.67,
              '缩放':0.55*1.2,
          },
      },
      '曹操·雄吞天下':{
          '背景调整':{
              'X轴':0.5,//默认为0.5
              'Y轴':0.5,//默认为0.3
              '缩放':1,//默认为1
          },
          '形象调整':{
              'X轴':0.35,
              'Y轴':0.7,
              '缩放':0.55*1.5,
          },
      },
      '神吕蒙·兼资文武':{
          '背景调整':1.25,
          '形象调整':{
              'X轴':0.35,
              'Y轴':0.6,
              '缩放':0.55*1.1,
          },
      },
      '蔡文姬·冠绝天下':{
          '背景调整':1,
          '形象调整':{
              'X轴':0.35,
              'Y轴':0.7,
              '缩放':0.55*1.2,
          },
      },
      '诸葛亮·龙跃凤鸣':{
          '背景调整':1,
          '形象调整':{
              'X轴':0.35,
              'Y轴':0.7,
              '缩放':0.55*1.2,
          },
      },
      '赵云·明良千古':{
          '背景调整':1,
          '形象调整':{
              'X轴':0.35,
              'Y轴':0.65,
              '缩放':0.55*1.4,
          },
      },
      '孙寒华·威灵尽显':{
          '背景调整':{
              'X轴':0.5,//默认为0.5
              'Y轴':0.6,//默认为0.3
              '缩放':1,//默认为1
          },
          '形象调整':{
              'X轴':0.35,
              'Y轴':0.62,
              '缩放':0.55*1.3,
          },
      },
      '花鬘·依心缱绻':{
          //NoAnimation不播放攻击动画（有的没有动画）
          '无点击动画':true,
          '背景调整':1,
          '形象调整':{
              'X轴':0.35,
              'Y轴':0.62,
              '缩放':0.55*1.3,
          },
      },
      '关索·虎年七夕':{
          //NoAnimation不播放攻击动画（有的没有动画）
          '无点击动画':true,
          '背景调整':{
              'X轴':0.5,//默认为0.5
              'Y轴':0.4,//默认为0.3
              '缩放':1,//默认为1
          },
          '形象调整':{
              'X轴':0.35,
              'Y轴':0.62,
              '缩放':0.55*1.2,
          },
      },
      '马超·星夜袭曹':{
          '背景调整':1,
          '形象调整':{
              'X轴':0.5,
              'Y轴':0.78,
              '缩放':0.55*1.3,
          },
      },
      '甘宁·锦帆游侠':{
          '背景调整':1,
          '形象调整':{
              'X轴':0.5,
              'Y轴':0.6,
              '缩放':0.55*1.2,
          },
      },
      '武诸葛亮·国之柱石':{
          '背景调整':1,
          '形象调整':{
              'X轴':0.25,
              'Y轴':0.83,
              '缩放':0.55*1.3,
          },
      },
      '孙策·逐鹿天下':{
          '背景调整':{
              'X轴':0.45,//默认为0.5
              'Y轴':0.37,//默认为0.3
              '缩放':0.8,//默认为1
          },
          '形象调整':{
              'X轴':0.35,
              'Y轴':0.7,
              '缩放':0.55*1.2,
          },
      },
      '灵雎·魂牵梦萦':{
          '背景调整':{
              'X轴':0.4,//默认为0.5
              'Y轴':0.65,//默认为0.3
              '缩放':1,//默认为1
          },
          '形象调整':{
              'X轴':0.35,
              'Y轴':0.7,
              '缩放':0.55*1.2,
          },
      },
      //关于特殊类型骨骼的示范
      //这个就不内置了，自行找资源吧
      '初音·乐舞歌姬':{
          '背景调整':{
              'X轴':0.37,//默认为0.5
              'Y轴':0.62,//默认为0.3
              '缩放':1.25*1.2,//默认为1
          },
          '形象调整':{
              'X轴':0.35,
              'Y轴':0.82,
              '缩放':0.16*1.2,
          },
          '骨骼设定':{
              '类型':{
                  '背景':'smn-rzsh-chuyin-bg.json',//默认为BeiJing.skel
                  '形象':'smn-rzsh-chuyin.json',//默认为XingXiang.skel
              },
              '动画':{
                  '背景-1':'play',//默认为chuchang
                  '背景-2':'play',//默认为beijing
                  '形象-1':'chuchang',//默认为chuchang
                  '形象-2':'daiji',//默认为daiji
                  '形象-3':'chuchang',//默认为gongji
              },
          },
      },
      '曹冲·清明踏青':{
          '背景调整':{
              'X轴':0.34,
              'Y轴':0.54,
              '缩放':0.82,
              },                 
          '形象调整':{
              'X轴':0.38,
              'Y轴':0.61,
              '缩放':0.6,
          },
          '骨骼设定':{
              '动画':{
                  '背景-1':'chuchang',//默认为chuchang
                  '背景-2':'play',//默认为beijing
                  '形象-1':'play',//默认为chuchang
                  '形象-2':'play',//默认为daiji
                  '形象-3':'dengru',//默认为gongji
              },
          },
      },
      '祝融·巾帼花舞':{
          '背景调整':{
              'X轴':0.5,//默认为0.5
              'Y轴':0.3,//默认为0.3
              '缩放':1,//默认为1
          },
          '形象调整':{
              'X轴':0.35,
              'Y轴':0.6,
              '缩放':0.55*1.0,
          },
          '骨骼设定':{
              '类型':{
                  '背景':'beijing.skel',//默认为BeiJing.skel
                  '形象':'daiji.skel',//默认为XingXiang.skel
              },
              '动画':{
                  '背景-1':'chuchang',//默认为chuchang
                  '背景-2':'play',//默认为beijing
                  '形象-1':'chuchang',//默认为chuchang
                  '形象-2':'daiji',//默认为daiji
                  '形象-3':'gongji',//默认为gongji
              },
          },
      },
  }
const rzshids = ['ksGame', 'transitionScreen', 'spineBg', 'spinePe', 'loginOverlay', 'loginBox', 'loginButton', 'usernameInput', 'passwordInput', 'updateLogModal', 'updateLogImage', 'updateLog', 'loginfo', 'loginfoname', 'reLog', 'offlineButton', 'kfBt', 'sqBt', 'kfSp', 'kfBg', 'kfHe', 'kfText', 'sqSp', 'sqBg', 'sqHe', 'sqText'
];
rzshids.forEach((id) => {
  const element = document.getElementById(id.toLowerCase());
  if (element !== null) {
    window[id] = element;
  } else {
    alert(`Element with ID ${id} not found.`);
    window[id] = undefined;
  }
});
let assetURL = '';
let rzsrc1 = '../../../index.html';
let rzsrc2 = '../spine';
(() => {
  let noname_inited = localStorage.getItem('noname_inited');
  if (noname_inited && noname_inited !== 'nodejs') {
    assetURL = noname_inited;
    rzsrc2 = 'extension/如真似幻/spine';
    rzsrc1 = 'file:///android_asset/www/index.html';
  }
})()
if (!sessionStorage.getItem("rzshk")) {
  sessionStorage.setItem("rzshk", true);
}
window.rzsh_xiaoshi=function(num,sum,spine,func,show){
     var opa=(sum-num)/sum;
     if(show) opa=1-opa;
     spine.alpha=opa;
     if(sum>num) {
         setTimeout(function() {
             window.rzsh_xiaoshi(num+1,sum,spine,func,show);
         },10);
     }else {
         if(func) func();
     }
 }
function showLogin() {
  window.loginOverlay.style.display = 'block';
  //window.usernameInput.value = '';
}

function hideLogin() {
  window.loginOverlay.style.display = 'none';
}
window.offlineButton.addEventListener('click', function () {
  sessionStorage.setItem('Network', 'offline');
  enterGame();
});
window.loginButton.addEventListener('click', function () {
  const username = window.usernameInput.value;
  const password = window.passwordInput.value;
  if (username != null && username.trim() != '') {
    if (password != '') {
      localStorage.setItem('loggedIn', username);
      localStorage.setItem('password_me', password);
      //window.config.connect_nickname=username;
      hideLogin();
      sessionStorage.setItem("rzshg", true);
      if (localStorage.getItem('loggedIn')) {
        window.loginfo.style.display = 'flex';
        window.loginfoname.textContent = localStorage.getItem('loggedIn');
      }
    } else {
      //alert('密码错误！')
      alert('请任意填写一个密码！');
    }
  }
});
function addToggleClickListener(button, page, div) {
  let isOpen = false;
  button.addEventListener('click', function () {
    isOpen = !isOpen;
    page.style.display = isOpen ? 'block' : 'none';
    if (isOpen) {
      document.addEventListener('click', handleDocumentClick);
    } else {
      document.removeEventListener('click', handleDocumentClick);
    }
  });
  function handleDocumentClick(event) {
    if (!div.contains(event.target) && event.target !== button) {
      page.style.display = 'none';
      isOpen = false;
      document.removeEventListener('click', handleDocumentClick);
    }
  }
  if (page.style.display === 'block') {
    isOpen = true;
    document.addEventListener('click', handleDocumentClick);
  }
}
//addToggleClickListener(window.updateLogImage, window.updateLogModal, window.updateLog);
//addToggleClickListener(window.updateLogImage, window.kfSp, window.kfBg);
//addToggleClickListener(window.kfBt, window.kfSp, window.kfBg); 
//有人是不是要来偷了QAQ，可惜有点看不懂捏
function openHelasisyURL(url,time,waitText,bilibiliText) {
    // 创建遮罩层
    const overlay = document.createElement('div');
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: wait;
        opacity: 0;
        transition: opacity 0.3s ease;
        -webkit-tap-highlight-color: transparent;  // 关键修改点
        user-select: none;                         // 防止文字被选中
        border-radius: 10px;
    `;

    // 创建内容窗口
    const contentWindow = document.createElement('div');
    contentWindow.style.cssText = `
        width: 80%;
        height: 80%;
        background: white;
        position: relative;
        cursor: default;
        transform: scale(0.8);
        opacity: 0;
        transition: transform 0.3s ease, opacity 0.3s ease;
        overflow: hidden;
        border-radius: 10px;
    `;
    const waitingText = `<span style='color: rgb(100, 255, 100)'>$</span> 秒后可关闭`,
        closeText = `点击空白区域可关闭窗口`,
        closeShortText = `点击这里关闭`;

    // 创建iframe
    const iframe = document.createElement('iframe');
    iframe.src = url||'https://space.bilibili.com/266915932';
    const isPcOpen = sessionStorage.getItem('no_bilibili');
    if(!isPcOpen/* || iframe.src && iframe.src.indexOf('bilibili')!=-1*/) {
        let adds = iframe.src=='https://space.bilibili.com/266915932'?30:0;
        let expand = iframe.src=='https://space.bilibili.com/266915932'?0:10;
        iframe.style.cssText = `
            transform: translate(-0.2%, ${-adds}%);
            width: 100.4%;
            height: ${(10000 / (100 - adds)) + expand}%;
            border: 0;
        `;
    }else {
        iframe.style.cssText = `
            width: 100%;
            height: 100%;
            border: 0;
        `;
    }
    // 添加onload事件处理
    let toOnload = (iframe.src.indexOf('bilibili')==-1 || isPcOpen) ? false : function() {
        try {
            let looping = true;
            var loopDel = function() {
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

                const miniMask = iframeDoc.querySelector('.bili-mini-mask');
                if (miniMask) {
                    miniMask.remove();
                }

                // 关闭"浏览方式"弹窗
                const dialogContent = iframeDoc.querySelector('.dialog-content');
                if (dialogContent) {
                    dialogContent.remove();
                }
                const dialogNav = iframeDoc.querySelector('.dialog-nav');
                if (dialogNav) {
                    dialogNav.remove();
                }
                const openAppMask = iframeDoc.querySelector('.openapp-mask');
                if (openAppMask) {
                    openAppMask.remove();
                }
                
                if(typeof bilibiliText=='string') {
                    // 移除"打开APP"文字
                    const openAppBtn = iframeDoc.querySelector('.v5-button__content__wrap');
                    if (openAppBtn) {
                        openAppBtn.innerText = bilibiliText;
                    }
                }else {
                    // 移除"打开APP"按钮
                    const openAppBtn = iframeDoc.querySelector('.v5-button');
                    if (openAppBtn) {
                        openAppBtn.remove();
                        const opus = iframeDoc.querySelector('.m-opus_wp');
                        if(opus) {
                            opus.style.transform = 'translateY(-4.5%)';
                        }
                    }
                }
                
                // 移除顶部栏
                const navbar = iframeDoc.querySelector('.m-navbar');
                if (navbar) {
                    navbar.remove();
                }
                if(looping) setTimeout(function() {
                    loopDel();
                }, 100);
            }
            loopDel();
            setTimeout(function() {
                looping = false;
            }, 5000);
        } catch (e) {
            console.log('跨域限制，无法直接操作iframe内容');
        }
    };

    contentWindow.appendChild(iframe);

    // 创建倒计时提示
    const countdownText = document.createElement('div');
    countdownText.style.cssText = `
        position: fixed;
        bottom: 12px;
        left: 50%;
        transform: translateX(-50%);
        color: white;
        font-size: 12px;
        text-align: center;
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s ease;
    `;
    let count = time||0;
    let text = waitText?(waitText+'，'):'';
    let waitingSecondText = waitingText.replace('$',count);
    countdownText.innerHTML = count?(text+waitingSecondText):closeText;
    
    // 组合元素
    overlay.appendChild(contentWindow);
    overlay.appendChild(countdownText);
    document.body.appendChild(overlay);

    iframe.onload = function() {
    
        // 初始化动画
        setTimeout(() => {
            overlay.style.opacity = '1';
            contentWindow.style.transform = 'scale(1)';
            contentWindow.style.opacity = '1';
            countdownText.style.opacity = '1';
        }, 10);
        
        if(toOnload) toOnload();
    
        // 倒计时逻辑
        const timer = setInterval(() => {
            count--;
            let waitingSecondText = waitingText.replace('$',count);
            countdownText.innerHTML = text+waitingSecondText;
            
            if (count <= 0) {
                clearInterval(timer);
                countdownText.innerHTML = `${text?(text+closeShortText):closeText}`;
                overlay.style.cursor = 'pointer';
                
                // 添加关闭事件（点击遮罩层空白处关闭）
                setTimeout(() => {
                    const closeHandler = e => {
                        if (e.target === overlay) {
                            // 关闭动画
                            overlay.style.opacity = '0';
                            contentWindow.style.transform = 'scale(0.8)';
                            contentWindow.style.opacity = '0';
                            countdownText.style.opacity = '0';
    
                            // 动画结束后移除元素
                            const removeElement = () => {
                                document.body.removeChild(overlay);
                                overlay.removeEventListener('transitionend', removeElement);
                            };
                            overlay.addEventListener('transitionend', removeElement);
                            
                            // 移除点击监听
                            overlay.removeEventListener('click', closeHandler);
                        }
                    };
                    overlay.addEventListener('click', closeHandler);
                }, 500);
            }
        }, 1000);
    }
};

window.kfBt.addEventListener('click', ()=>{
    openHelasisyURL();
});
//点击链接加入群聊【无名杀琉璃版交流群】：http://qm.qq.com/cgi-bin/qm/qr?_wv=1027&k=S4IzNHdf61zzH-XEXrfmVnw7TCs8l00I&authKey=%2FFmCQvJdkeswVNriHA0G5vA4uCXk5AxbbcgiSLODjjA8t113Y6AIHEmeFb5Jf0Kg&noverify=0&group_code=623260187
window.sqBt.addEventListener('click', ()=>{
    openHelasisyURL('https://qm.qq.com/q/5CRCSutmHS');
});
window.updateLogImage.addEventListener('click', ()=>{
    openHelasisyURL('https://docs.qq.com/doc/DTGJNbG9GS1BaSGZ4');
});
//addToggleClickListener(window.sqBt, window.sqSp, window.sqBg);
var version = window.noname_update.version;
var exversion=localStorage.getItem('liulikillVersion');//window.rzsh_update.exversion;
//如真版本更新提示
/*if (version != localStorage.getItem('changever')) {
  localStorage.setItem('changever', version);
  window.updateLogModal.style.display = 'block';
  addToggleClickListener(window.updateLogImage, window.updateLogModal, window.updateLog);
};*/
if (exversion != localStorage.getItem('exchangever')) {
  localStorage.setItem('exchangever', exversion);
  //window.kfSp.style.display = 'block';
  //addToggleClickListener(window.kfBt, window.kfSp, window.kfBg); 
  openHelasisyURL(false,15,'关注UP获取琉璃版独家爆料');
}else {
    //日限两次：2:00~14:00，14:00~次日2:00
    const checkMyUpdate = async function(text, bool) {
        const uid = 'id';
        const apiUrl = `https://api.bilibili.com/x/polymer/web-dynamic/v1/feed/space?host_mid=${uid}`;
        const storageKey = 'bili_last_dynamic_id';
        const dateKey = 'bili_last_check_date';
        
        const getToday = () => {
            const now = new Date();
            return `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}`;
        };
        
        const today = getToday();
        const lastCheckDate = localStorage.getItem(dateKey);
    
        if (!bool && lastCheckDate === today) {
            return false;
        }
    
        try {
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error(`网络错误: ${response.status}`);
            
            const data = await response.json();
            if (data.code !== 0) throw new Error(`API错误: ${data.message}`);
            
            // 获取最新动态
            const latestDynamic = data.data.items[1];
            if (!latestDynamic) throw new Error('未找到动态数据');
            
            const dynamicId = latestDynamic.id_str;
            const dynamicUrl = `https://t.bilibili.com/${dynamicId}`;
            const lastId = localStorage.getItem(storageKey);
    
            localStorage.setItem(dateKey, today);
            
            if (bool || lastId !== dynamicId) {
                localStorage.setItem(storageKey, dynamicId);
                openHelasisyURL(dynamicUrl, 5, text);
                return true;
            }
            return false;
        } catch (error) {
            console.error('检查更新失败:', error);
            if (lastCheckDate === today) {
                localStorage.removeItem(dateKey);
            }
            return false;
        }
    };
    checkMyUpdate('主播更新了一条动态');//true强制弹出
}
if (localStorage.getItem('loggedIn')) {
  window.loginfo.style.display = 'flex';
  window.loginfoname.textContent = localStorage.getItem('loggedIn');
}
var rzaudio=sessionStorage.getItem("rzsh_audio");
var rzback=sessionStorage.getItem("rzsh_background");
document.getElementById('version').innerHTML = 'V' + version;
var isOpeningVER=false;
var developerNUM=0;
document.getElementById('version').addEventListener('click', function () {
    developerNUM++;
    if(developerNUM>=6) {
        developerNUM=0;
        if(!confirm('开发者功能：是否重置本游戏数据？')) return;
        localStorage.setItem('rz_KFZ_reload','reload');
        enterGame();
		return;
    }else {
        var num=developerNUM;
        setTimeout(function() {
            if(developerNUM<=num) {
                developerNUM=0;
            }
        },500);
    }
});
//document.getElementById('version').innerHTML = '三国杀·琉璃版';
if(rzaudio&&rzback) {
    document.getElementById('ksgame').volume = (rzaudio/8)*0.7+0.3*(rzaudio>0?1:0);
    document.getElementById('outgame').volume = rzback/8;
}
document.getElementById('updateve').innerHTML = version + '版本更新啦';
document.getElementById('updatetext').innerHTML = window.noname_update.changeLog.join(',<br>');
document.getElementById('kftext').innerHTML = window.rzsh_update.changeLog.join(',<br>');
window.reLog.addEventListener('click', function () {
  window.loginfo.style.display = 'none';
  localStorage.removeItem('loggedIn');
  localStorage.removeItem('password_me');
  window.usernameInput.value = '';
  window.passwordInput.value = '';
  showLogin();
});
let dpr = Math.max(window.devicePixelRatio * (window.documentZoom ? window.documentZoom : 1), 1);
let rzapp;
rzapp = new PIXI.Application({
  resizeTo: document.body,
  backgroundAlpha: 0,
  resolution: dpr,
  autoDensity: true,
  antialias: true,
  forceCanvas: false,    
});
document.body.appendChild(rzapp.view);
rzapp.view.style.position = 'absolute';
rzapp.view.style.left = '0px';
rzapp.view.style.zIndex = '1';
rzapp.view.style.top = '0px';
const rzw = document.body.clientWidth / 1103;
const rzh = document.body.clientHeight / 514;
const xloader = new PIXI.Loader();
let spineot, spinebj, spinepe,spinedoor;
let bji,bjk,pei,pek,pel;
var loginui=localStorage.getItem("rzsh_loginui");
if(!loginui) {
    var loginui='戏志才·举棋若定';
}
//检测3秒内加载是否成功
setTimeout(function(){
    if(!window.isLoadSpine) {
        localStorage.setItem("rzsh_loginui",'戏志才·举棋若定');
        var str='「'+loginui+'」加载失败，已重置初始动画';
        alert(str);
        window.location.reload(true);
    }
},5000);
var beijing_set='BeiJing.skel';
var xingxiang_set='XingXiang.skel';
if(window.chgBackgroundlist[loginui]&&window.chgBackgroundlist[loginui]['骨骼设定']&&window.chgBackgroundlist[loginui]['骨骼设定']['类型']) {
    if(window.chgBackgroundlist[loginui]['骨骼设定']['类型']['背景']) {
        beijing_set=window.chgBackgroundlist[loginui]['骨骼设定']['类型']['背景'];
    }
    if(window.chgBackgroundlist[loginui]['骨骼设定']['类型']['形象']) {
        xingxiang_set=window.chgBackgroundlist[loginui]['骨骼设定']['类型']['形象'];
    }
}
xloader.add('spineBJ', assetURL + rzsrc2 + '/startSpine/'+loginui+'/'+beijing_set);
xloader.add('spinePE', assetURL + rzsrc2 + '/startSpine/'+loginui+'/'+xingxiang_set);
//xloader.add('spineBJ', assetURL + rzsrc2 + '/启动页封面/BeiJing.skel');
//xloader.add('spinePE', assetURL + rzsrc2 + '/启动页封面/XingXiang.skel');
xloader.add('spineOT', assetURL + rzsrc2 + '/Ot/kaishiyouxi.skel');
window.loginui=localStorage.getItem("rzsh_loginui");
if(!loginui) {
    window.loginui='戏志才·举棋若定';
}
xloader.load(() => {
  spinebj = new PIXI.spine.Spine(xloader.resources.spineBJ.spineData);
  spinepe = new PIXI.spine.Spine(xloader.resources.spinePE.spineData);
  spineot = new PIXI.spine.Spine(xloader.resources.spineOT.spineData);  
  window.rzsh_xiaoshi(0,20,spinebj,false,true);
  window.rzsh_xiaoshi(0,10,spinepe,false,true);
  window.rzsh_xiaoshi(0,50,spineot,false,true);
    let bjanimations =spinebj.stateData.skeletonData.animations;
    let peanimations =spinepe.stateData.skeletonData.animations;
    var bjs1='chuchang';
    var bjs2='beijing';
    var xxs1='chuchang';
    var xxs2='daiji';
    var xxs3='gongji';
    if(window.chgBackgroundlist[loginui]&&window.chgBackgroundlist[loginui]['骨骼设定']&&window.chgBackgroundlist[loginui]['骨骼设定']['动画']) {
        if(window.chgBackgroundlist[loginui]['骨骼设定']['动画']['背景-1']) {
            bjs1=window.chgBackgroundlist[loginui]['骨骼设定']['动画']['背景-1'];
        }
        if(window.chgBackgroundlist[loginui]['骨骼设定']['动画']['背景-2']) {
            bjs2=window.chgBackgroundlist[loginui]['骨骼设定']['动画']['背景-2'];
        }
        if(window.chgBackgroundlist[loginui]['骨骼设定']['动画']['形象-1']) {
            xxs1=window.chgBackgroundlist[loginui]['骨骼设定']['动画']['形象-1'];
        }
        if(window.chgBackgroundlist[loginui]['骨骼设定']['动画']['形象-2']) {
            xxs2=window.chgBackgroundlist[loginui]['骨骼设定']['动画']['形象-2'];
        }
        if(window.chgBackgroundlist[loginui]['骨骼设定']['动画']['形象-3']) {
            xxs3=window.chgBackgroundlist[loginui]['骨骼设定']['动画']['形象-3'];
        }
    }
    for (let i = 0; i < bjanimations.length; i++) {
      if(bjanimations[i].name.toLowerCase()==bjs1)bji=bjanimations[i].name;
      if(bjanimations[i].name.toLowerCase()==bjs2)bjk=bjanimations[i].name;
      if(bjanimations.length==1)bji=bjk;
    }
    for (let i = 0; i < peanimations.length; i++) {
      if(peanimations[i].name.toLowerCase()==xxs1)pei=peanimations[i].name;
      if(peanimations[i].name.toLowerCase()==xxs2)pek=peanimations[i].name;
      if(peanimations[i].name.toLowerCase()==xxs3)pel=peanimations[i].name;
      if(peanimations.length==1)pei=pek=pel=peanimations[0].name;
      if(peanimations.length==2){
      pek=peanimations[0].name;
      pei=pel=peanimations[1].name; 
      }
    }
  spinebj.state.setAnimation(0, bji, false);  
  spinebj.state.addListener({ 
  complete: function(track, event) { 
  spinebj.state.setAnimation(0, bjk, true);  
  }    
  })
/*  spinebj.state.tracks[0].onComplete = function (){
  spinebj.state.setAnimation(0, bjk, true);}*/
  spinepe.state.setAnimation(0, pei, false);
  spinepe.state.addListener({ 
  complete: function(track, event) { 
  spinepe.state.setAnimation(0, pek, true);
  }    
  })
/*  spinepe.state.tracks[0].onComplete = function (){
  spinepe.state.setAnimation(0, pek, true);  }    */
  spineot.state.setAnimation(0, 'animation', true);
  //行了电脑版大大，专门为你留下一个接口了
  var scaleCHGCHG = sessionStorage.getItem('rzsh_scaleFIX') || 1;
  //Helasisy改
  if(chgBackgroundlist[loginui]) {
    if(chgBackgroundlist[loginui]['背景调整']&&typeof chgBackgroundlist[loginui]['背景调整'] == 'object') {
      var bjtz=chgBackgroundlist[loginui]['背景调整'];
      spinebj.x = bjtz['X轴'] * document.body.clientWidth;
      spinebj.y = bjtz['Y轴'] * document.body.clientHeight;
      var bj=chgBackgroundlist[loginui]['背景调整']['缩放']*0.8;
    }else {
      spinebj.x = 0.5 * document.body.clientWidth;
      spinebj.y = 0.3 * document.body.clientHeight;
      var bj=chgBackgroundlist[loginui]['背景调整']*0.8*1.25;
    }
    spinebj.scale.set(bj*scaleCHGCHG);
    var pe=chgBackgroundlist[loginui]['形象调整'];
    spinepe.x = pe['X轴'] * document.body.clientWidth;
    spinepe.y = pe['Y轴'] * document.body.clientHeight;
    spinepe.scale.set(pe['缩放']*scaleCHGCHG);
    /*var ot=chgBackgroundlist[loginui].ot;
    spineot.x = ot.x * document.body.clientWidth;
    spineot.y = ot.y * document.body.clientHeight;
    spineot.scale.set(ot['缩放']);*/
  }else {
    spinebj.scale.set(1);
    spinepe.x = 0.35 * document.body.clientWidth;
    spinepe.y = 0.6 * document.body.clientHeight;
    //开始界面角色大小这里调
    spinepe.scale.set(0.55*1.2*scaleCHGCHG);
    /*spineot.x = 0.75 * document.body.clientWidth;
    spineot.y = 0.5 * document.body.clientHeight;
    spineot.scale.set(0.45);*/
  }
    spineot.x = 0.75 * document.body.clientWidth;
    spineot.y = 0.5 * document.body.clientHeight;
    spineot.scale.set(0.45*scaleCHGCHG);
  //加载已成功
  window.isLoadSpine=true;
  
  spineot.interactive = true;
  spineot.on('pointerup', onLogin);
  rzapp.stage.addChild(spinebj, spinepe, spineot);
})
function onLogin(event) {
  spineot.state.setAnimation(0, 'animation2', true);
  spineot.state.addListener({ 
  complete: function(track, event) { 
  spineot.state.setAnimation(0, 'animation', true, 0);
  }    
  })
  if(localStorage.getItem('rzLock_spn')=='on'&&window.isOnLogin) return;
  window.isOnLogin=true;
  if(chgBackgroundlist[loginui]&&chgBackgroundlist[loginui]['无点击动画']) {
    window.ksGame.play();
      setTimeout(function(){
      if (sessionStorage.getItem("rzshg") || (localStorage.getItem('loggedIn') != null && localStorage.getItem('loggedIn'))) {
      sessionStorage.setItem('Network', 'online');
      enterGame();
    } else {
      showLogin();
    }
      },1500);
    return;
  }
 /* spineot.state.tracks[0].onComplete = function (){
  spineot.state.setAnimation(0, 'animation', true, 0);}*/
  spinepe.state.setAnimation(0, pel, true);
  spinepe.state.addListener({ 
  complete: function(track, event) { 
  spinepe.state.setAnimation(0, pek, true);
  }    
  })
/*  spinepe.state.tracks[0].onComplete = function (){
  spinepe.state.setAnimation(0, pek, true);}*/
  window.ksGame.play();
  if(pei==pek||pek==pel)
    spineot.state.addListener({ 
  complete: function(track, event) { 
//  spineot.state.tracks[0].onComplete = function () {
    if (sessionStorage.getItem("rzshg") || (localStorage.getItem('loggedIn') != null && localStorage.getItem('loggedIn'))) {
      sessionStorage.setItem('Network', 'online');
      enterGame();
    } else {
      showLogin();
    }
  }})
  else    spinepe.state.addListener({ 
  complete: function(track, event) { 
    if (sessionStorage.getItem("rzshg") || (localStorage.getItem('loggedIn') != null && localStorage.getItem('loggedIn'))) {
      sessionStorage.setItem('Network', 'online');
      enterGame();
    } else {
      showLogin();
    }
}})
}
function enterGame() {
  //var spnlist=['spintot','xloader','spineot','spinebj','spinepe','rzapp'];
  window.rzsh_xiaoshi(0,5,spinepe,function(){
      spinepe.destroy();
      spinepe = null;
  });
  setTimeout(function(){
    window.rzsh_xiaoshi(0,10,spinebj,function(){
      spinebj.destroy();
      spinebj = null;
    });
  },100);
  window.rzsh_xiaoshi(0,10,spineot);
  setTimeout(function(){
  spineot.interactive = false;
  spineot.off('pointerup', onLogin);
  xloader.destroy();
  spineot.destroy();
  //spinebj.destroy();
  //spinepe.destroy();
  rzapp.stop();
  spineot = null;
  //spinebj = null;
  //spinepe = null;
  PIXI.utils.clearTextureCache();
  rzapp.view.remove();
  rzapp.destroy(true);
    window.location.href = rzsrc1;
  },300)


}
/*state.addListener({ complete: function(track, event) { } */